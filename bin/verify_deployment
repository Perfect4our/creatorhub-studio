#!/usr/bin/env ruby

puts "ğŸ” Verifying deployment configuration..."

# Check for Rails 8 compatibility
puts "\nğŸ“‹ Checking Rails 8 compatibility:"

# Check Gemfile
gemfile_content = File.read('Gemfile')
if gemfile_content.include?('gem "solid_cache"') && !gemfile_content.include?('# gem "solid_cache"')
  puts "âŒ Solid gems are still active in Gemfile"
  exit 1
else
  puts "âœ… Solid gems properly commented out"
end

# Check production config
prod_config = File.read('config/environments/production.rb')
if prod_config.include?('config.action_cable.adapter = :redis')
  puts "âŒ Old ActionCable syntax found"
  exit 1
elsif prod_config.include?('config.action_cable.cable = {')
  puts "âœ… ActionCable configured for Rails 8"
else
  puts "âš ï¸  ActionCable configuration not found"
end

# Check cable.yml
cable_config = File.read('config/cable.yml')
if cable_config.include?('adapter: solid_cable')
  puts "âŒ Cable.yml still using solid_cable"
  exit 1
elsif cable_config.include?('adapter: redis')
  puts "âœ… Cable.yml configured for Redis"
else
  puts "âš ï¸  Redis configuration not found in cable.yml"
end

# Check for master key
if File.exist?('config/master.key')
  puts "âœ… Master key found for credentials"
else
  puts "âŒ Master key missing - credentials won't decrypt"
  exit 1
end

puts "\nğŸ‰ All checks passed! Ready for deployment."
puts "\nğŸ“ Remember to set these environment variables on Railway:"
puts "   RAILS_MASTER_KEY=#{File.read('config/master.key').strip}"
puts "   RAILS_ENV=production"
puts "   RACK_ENV=production"
puts "\nğŸš€ Your app should deploy successfully now!" 