#!/usr/bin/env ruby

require_relative '../config/environment'

puts "ğŸ¯ TikTok Studio - YouTube Stats Updater"
puts "=" * 50

# Find all active YouTube subscriptions
youtube_subscriptions = Subscription.active.where(platform: 'youtube')

if youtube_subscriptions.empty?
  puts "âŒ No active YouTube subscriptions found"
  exit 1
end

puts "ğŸ“Š Found #{youtube_subscriptions.count} active YouTube subscription(s)"

youtube_subscriptions.each do |subscription|
  puts "\nğŸ”„ Processing subscription ID: #{subscription.id}"
  puts "   Channel ID: #{subscription.channel_id}"
  
  begin
    # Track daily views using public API
    puts "   ğŸ“ˆ Tracking daily views..."
    subscription.track_daily_views!
    
    # Sync stats using authenticated API
    puts "   ğŸ”„ Syncing detailed stats..."
    youtube_service = YoutubeService.new(subscription)
    if youtube_service.sync!
      puts "   âœ… Successfully updated stats"
    else
      puts "   âš ï¸  Stats sync failed (but daily tracking succeeded)"
    end
    
  rescue => e
    puts "   âŒ Error: #{e.message}"
  end
end

puts "\nğŸ“Š Final Statistics:"
youtube_subscriptions.each do |subscription|
  latest_stat = subscription.daily_stats.recent.first
  latest_tracking = subscription.daily_view_trackings.recent.first
  
  puts "   Subscription #{subscription.id}:"
  if latest_stat
    puts "     ğŸ“Š Latest Daily Stat: #{latest_stat.views} views, #{latest_stat.followers} subscribers (#{latest_stat.date})"
  end
  if latest_tracking
    puts "     ğŸ“ˆ Latest Tracking: #{latest_tracking.total_views} views, #{latest_tracking.daily_view_gain} daily gain (#{latest_tracking.tracked_date})"
  end
  puts "     ğŸ“š Total Daily Stats: #{subscription.daily_stats.count}"
  puts "     ğŸ“Š Total Trackings: #{subscription.daily_view_trackings.count}"
end

puts "\nğŸ‰ YouTube stats update completed!"
puts "ğŸ’¡ Tip: This script runs automatically every day at 2am via TrackDailyViewsJob" 